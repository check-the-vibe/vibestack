#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PORT=3000

echo "════════════════════════════════════════════════════════════════"
echo "  Vibestack + ngrok"
echo "════════════════════════════════════════════════════════════════"
echo ""

check_jq() {
    if ! command -v jq &> /dev/null; then
        echo "❌ jq is not installed (required for URL detection)"
        echo ""
        echo "Install jq:"
        echo "  macOS:   brew install jq"
        echo "  Linux:   apt-get install jq / yum install jq"
        echo ""
        exit 1
    fi
    echo "✓ jq found"
}

check_ngrok_running() {
    if ! curl -s http://127.0.0.1:4040/api/tunnels > /dev/null 2>&1; then
        echo "❌ ngrok is not running"
        echo ""
        echo "Please start ngrok first:"
        echo "  ngrok http ${PORT}"
        echo ""
        exit 1
    fi
    echo "✓ ngrok is running"
}

detect_url() {
    echo ""
    echo "Detecting ngrok tunnel URL for port ${PORT}..."
    
    TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | \
        jq -r --arg port "${PORT}" '.tunnels[] | select(.config.addr | contains(":" + $port)) | .public_url' 2>/dev/null | \
        grep '^https://' | head -1)
    
    if [[ -z "${TUNNEL_URL}" ]]; then
        echo "⚠ No tunnel found for port ${PORT}"
        echo ""
        echo "Available tunnels:"
        curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[] | "  \(.proto)://\(.config.addr) -> \(.public_url)"'
        echo ""
        echo "Continuing anyway - startup.sh will attempt detection..."
        echo ""
    else
        echo "✓ Tunnel URL detected: ${TUNNEL_URL}"
        echo "  Inspect at: http://127.0.0.1:4040"
    fi
}

start_vibestack() {
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo "  🚀 Starting Vibestack"
    echo "════════════════════════════════════════════════════════════════"
    echo ""
    
    cd "${SCRIPT_DIR}"
    exec "${SCRIPT_DIR}/startup.sh" follow
}

check_jq
check_ngrok_running
detect_url
start_vibestack
